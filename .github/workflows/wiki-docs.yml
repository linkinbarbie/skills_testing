name: Wiki Docs

on:
  workflow_dispatch:
  push:
    paths:
      - "README.md"
      - "SKILLS.md"
      - ".codex/skills/**"

jobs:
  generate-wiki:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare output folder
        run: mkdir -p generated

      - name: Generate wiki markdown
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.n8n }}
          model: gpt-5-mini
          prompt: |
            Use $docs-helper to write one short paragraph for this repo's wiki.
            The paragraph should explain what the repo does and how skills work here.
            Do not include headings, bullet points, or raw file dumps.
          output-file: generated/Repo-Docs.md

      - name: Upload wiki artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo-docs
          path: generated/Repo-Docs.md

  push-wiki:
    runs-on: ubuntu-latest
    needs: generate-wiki
    steps:
      - name: Download wiki artifact
        uses: actions/download-artifact@v4
        with:
          name: repo-docs
          path: generated

      - name: Push to GitHub Wiki
        env:
          WIKI_TOKEN: ${{ secrets.git }}
        run: |
          if [ -z "$WIKI_TOKEN" ]; then
            echo "WIKI_TOKEN secret is required to push to the wiki."
            exit 1
          fi
          git clone "https://x-access-token:${WIKI_TOKEN}@github.com/${GITHUB_REPOSITORY}.wiki.git" wiki
          cp generated/Repo-Docs.md wiki/Repo-Docs.md
          cd wiki
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add Repo-Docs.md
          if git diff --cached --quiet; then
            echo "No wiki changes to commit."
            exit 0
          fi
          git commit -m "Update repo docs"
          git push
